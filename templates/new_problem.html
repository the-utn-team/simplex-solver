<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nuevo Problema - Simplex Solver</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* üí° Estilo del bot√≥n principal */
        .btn-submit {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .btn-submit:hover:enabled {
            background-color: #0056b3;
        }

        .btn-submit:disabled {
            background-color: #c0c0c0;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.8;
        }

        /* üî¥ Solo se activa en inputs inv√°lidos luego del intento de enviar */
        .input-error {
            border: 2px solid #dc3545;
        }

        .error-msg {
            color: #dc3545;
            font-size: 0.85em;
            margin-top: 4px;
            display: none;
        }

        .error-msg.active {
            display: block;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Mensajes flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash {{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <h1>Simplex Solver</h1>
        <p class="subtitle">Ingresa tu problema de programaci√≥n lineal</p>

        <form id="formularioSimplex" method="POST" action="{{ url_for('ui.new_problem') }}">
            
            <!-- Tipo de problema -->
            <section class="problem-type">
                <h3>Tipo de problema</h3>
                <label><input type="radio" name="problem_type" value="maximize" checked> Maximizar</label>
                <label><input type="radio" name="problem_type" value="minimize"> Minimizar</label>
            </section>

            <!-- Funci√≥n objetivo -->
            <div class="section">
                <h3>Coeficientes de la funci√≥n objetivo</h3>
                <div id="objective-terms" class="terms-container"></div>
                <button type="button" id="add-term" class="btn-secondary">A√±adir coeficiente</button> 
            </div>

            <script>
                let termCount = 0;

                document.getElementById("add-term").addEventListener("click", () => {
                    termCount++;
                    const termDiv = document.createElement("div");
                    termDiv.classList.add("term-row");

                    termDiv.innerHTML = `
                        <input type="number" class="coef-input" name="objective[]" placeholder="Coef" step="any">
                        <span class="variable-label">x${termCount}</span>
                        <button type="button" class="btn-delete" title="Eliminar t√©rmino">üóëÔ∏è</button>
                        <div class="error-msg">Usa puntos en lugar de comas.</div>
                    `;

                    termDiv.querySelector(".btn-delete").addEventListener("click", () => {
                        termDiv.remove();
                        updateVariableLabels();
                    });

                    document.getElementById("objective-terms").appendChild(termDiv);
                    updateVariableLabels();
                    updateConstraintInputs();
                });

                function updateVariableLabels() {
                    const rows = document.querySelectorAll(".term-row");
                    termCount = rows.length;
                    rows.forEach((row, index) => {
                        row.querySelector(".variable-label").textContent = `x${index + 1}`;
                    });
                }

                function updateConstraintInputs() {
                    const constraints = document.querySelectorAll(".constraint");
                    constraints.forEach(constraint => {
                        const inputs = constraint.querySelectorAll(".constraint-coef");
                        const diff = termCount - inputs.length;

                        if (diff > 0) {
                            for (let i = inputs.length + 1; i <= termCount; i++) {
                                const input = document.createElement("input");
                                input.type = "number";
                                input.classList.add("constraint-coef");
                                input.name = `constraint_${i}[]`;
                                input.placeholder = `a${i}`;
                                input.step = "any";
                                constraint.insertBefore(input, constraint.querySelector("select"));
                            }
                        } else if (diff < 0) {
                            for (let i = 0; i < Math.abs(diff); i++) {
                                constraint.querySelectorAll(".constraint-coef")[inputs.length - 1 - i].remove();
                            }
                        }
                    });
                }
            </script>

            <!-- Restricciones -->
            <section class="constraints-section">
                <h3>Restricciones</h3>
                <div class="info-box">
                    <strong>Nota:</strong> No es necesario ingresar las restricciones de no negatividad.
                    El sistema las asume autom√°ticamente por defecto.
                </div>
                <div id="constraints-container" class="constraints-container"></div>
                <button type="button" id="add-constraint" class="btn-secondary">A√±adir restricci√≥n</button>
            </section>

            <!-- Botones -->
            <div class="button-container">
                <button id="btnCalcular" type="submit" class="btn-submit" disabled>Cargar Problema</button>
            </div>

            <div class="button-container">
                <a href="{{ url_for('ui.index') }}" class="btn-secondary">Volver</a>
            </div>

        </form>
    </div>

    <!-- A√±adir restricci√≥n -->
    <script>
        document.getElementById("add-constraint").addEventListener("click", function() {
            const container = document.getElementById("constraints-container");
            const div = document.createElement("div");
            div.className = "constraint";

            let coefInputs = "";
            for (let i = 1; i <= termCount; i++) {
                coefInputs += `<input type="number" class="constraint-coef" name="constraint_${i}[]" placeholder="a${i}" step="any"> `;
            }

            div.innerHTML = `
                ${coefInputs}
                <select name="constraint_sign[]">
                    <option value="<=">&le;</option>
                    <option value="=">=</option>
                    <option value=">=">&ge;</option>
                </select>
                <input type="number" name="constraint_rhs[]" placeholder="b" step="any">
                <button type="button" class="delete-btn" onclick="removeConstraint(this)">üóë</button>
                <div class="error-msg">Usa puntos en lugar de comas.</div>
            `;
            container.appendChild(div);
        });

        function removeConstraint(btn) {
            btn.parentElement.remove();
        }
    </script>

    <!-- Generar vista previa -->
    <script>
        document.getElementById("preview-problem").addEventListener("click", showPreview);

        function showPreview() {
            const type = document.querySelector('input[name="problem_type"]:checked')?.value || "maximize";
            const coefInputs = document.querySelectorAll('#objective-terms input[type="number"]');
            const constraints = document.querySelectorAll('.constraint');

            let text = `${type === "maximize" ? "Maximizar" : "Minimizar"}:\nZ = `;
            text += Array.from(coefInputs).map((input, i) => `${input.value || 0}x${i + 1}`).join(" + ");
            text += `\nSujeto a:\n`;

            constraints.forEach((constraint) => {
                const coefInputs = constraint.querySelectorAll('input[type="number"]:not([name*="rhs"])');
                const sign = constraint.querySelector('select')?.value || "<=";
                const rhs = constraint.querySelector('input[name*="rhs"]')?.value || 0;

                const expr = Array.from(coefInputs)
                    .map((input, i) => `${input.value || 0}x${i + 1}`)
                    .join(" + ");

                text += `${expr} ${sign} ${rhs}\n`;
            });

            const nonNeg = Array.from(coefInputs)
                .map((_, i) => `x${i + 1} ‚â• 0`)
                .join(", ");
            text += `${nonNeg}`;

            document.getElementById("preview-text").textContent = text;
            document.getElementById("problem-preview").classList.remove("hidden");
        }
    </script>

    <!-- üîí VALIDACI√ìN Y BLOQUEO DE BOT√ìN -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("formularioSimplex");
            const botonCalcular = document.getElementById("btnCalcular");

            function validarFormulario(mostrarErrores = false) {
                let valido = true;
                const inputs = form.querySelectorAll("input[type='number']");

                inputs.forEach(input => {
                    const valor = input.value.trim();
                    const errorMsg = input.parentElement.querySelector(".error-msg");

                    if (valor.includes(",")) {
                        valido = false;
                        if (mostrarErrores) {
                            input.classList.add("input-error");
                            if (errorMsg) errorMsg.classList.add("active");
                        }
                    } else if (valor === "" || isNaN(valor)) {
                        valido = false;
                        if (mostrarErrores) {
                            input.classList.add("input-error");
                            if (errorMsg) errorMsg.classList.remove("active");
                        }
                    } else {
                        input.classList.remove("input-error");
                        if (errorMsg) errorMsg.classList.remove("active");
                    }
                });

                botonCalcular.disabled = !valido;
                return valido;
            }

            form.addEventListener("input", () => validarFormulario(false));

            form.addEventListener("submit", (event) => {
                if (!validarFormulario(true)) {
                    event.preventDefault();
                    alert("Corrige los errores antes de calcular el problema.");
                }
            });
        });
    </script>

</body>
</html>

